<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/image/icon.png" type="image/x-icon" />
  <title>–°–ø–∏—Å–æ–∫ / —Å–æ—Ü. —Å–µ—Ç–∏</title>
  <link rel="stylesheet" href="servers.css">
  <style>
    /* –ß—Ç–æ–±—ã iframe –Ω–µ –¥–∞–≤–∞–ª —Å–∫—Ä–æ–ª–ª—ã –∏ —Ä–∞–º–∫–∏ */
    iframe {
      border: none;
      overflow: hidden;
      /* –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã —Ä–æ–≤–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É */
      height: 40px;
      width: 220px;
      /* —á—Ç–æ–±—ã –Ω–µ –≤–ª–∏—è–ª –Ω–∞ —Å—Ç—Ä–æ—á–∫—É */
      vertical-align: middle;
    }

    /* –í—ã—Ä–æ–≤–Ω—è—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .filter-row {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: nowrap;
    }

    /* –°–µ–ª–µ–∫—Ç –∏ –∫–Ω–æ–ø–∫–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –≤—ã—Å–æ—Ç—ã */
    #filterSocialNetwork,
    #openModalBtn {
      height: 40px;
      font-size: 16px;
    }

    /* –ß—É—Ç—å —Å—É–∑–∏—Ç—å —Å–µ–ª–µ–∫—Ç */
    #filterSocialNetwork {
      min-width: 150px;
    }

    /* –ö–Ω–æ–ø–∫–∞ ‚Äî pointer –∫—É—Ä—Å–æ—Ä */
    #openModalBtn {
      cursor: pointer;
      padding: 0 15px;
    }
  </style>
</head>
<body>

<header>
  <h1>–°–ø–∏—Å–æ–∫ / —Å–æ—Ü. —Å–µ—Ç–∏</h1>
  <a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
</header>

<div class="container">
  <div class="search-and-add">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">

    <div class="filter-row">
      <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ—Ü. —Å–µ—Ç–µ–π —Å–ª–µ–≤–∞ -->
      <select id="filterSocialNetwork" title="–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ü. —Å–µ—Ç—å">
        <option value="" selected>–í—Å–µ —Å–æ—Ü. —Å–µ—Ç–∏</option>
        <option value="telegram">–¢–µ–ª–µ–≥—Ä–∞–º</option>
        <option value="discord">–î–∏—Å–∫–æ—Ä–¥</option>
      </select>

      <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π lives.html -->
      <iframe src="lives.html" style="background: transparent;" allowtransparency="true" frameborder="0"></iframe>

      <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ —Å–ø—Ä–∞–≤–∞ -->
      <button id="openModalBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </div>
  </div>

  <div class="server-grid" id="serverGrid"></div>
</div>

<div id="modalOverlay">
  <div id="modalContent">
    <button id="closeModal">√ó</button>
    <h2 style="margin-top: 10px; margin-bottom: 20px;">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
    <form id="serverForm">
      <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞:</label>
      <input type="text" id="title" name="title" required>

      <label for="imageUrl">–°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
      <input type="url" id="imageUrl" name="imageUrl" required placeholder="https://example.com/image.jpg">

      <label for="inviteUrl">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:</label>
      <input type="url" id="inviteUrl" name="inviteUrl" required placeholder="https://discord.gg/invite">

      <label for="modalSocialNetwork">–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</label>
      <select id="modalSocialNetwork" name="socialNetwork" required>
        <option value="telegram">–¢–µ–ª–µ–≥—Ä–∞–º</option>
        <option value="discord">–î–∏—Å–∫–æ—Ä–¥</option>
      </select>

      <div class="form-actions">
        <button type="submit" class="join-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<button id="back-to-top" class="back-to-top" title="–ù–∞–≤–µ—Ä—Ö">‚Üë</button>

<script>
  let serversDatabase = [];

  function showNotification(message, isSuccess = true) {
    const notification = document.createElement('div');
    notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }

  async function loadServers() {
    try {
      const response = await fetch('/get_servers');
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      serversDatabase = await response.json();
      renderServers();
    } catch (error) {
      showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', false);
    }
  }

  async function saveServers() {
    try {
      const response = await fetch('/save_servers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(serversDatabase)
      });
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    } catch (error) {
      showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', false);
    }
  }

  function createServerCard(server, index) {
    const socialNetworkMap = {
      discord: '–î–∏—Å–∫–æ—Ä–¥',
      telegram: '–¢–µ–ª–µ–≥—Ä–∞–º'
    };
    const metaInfo = `üì∏${socialNetworkMap[server.socialNetwork]}`;

    const card = document.createElement('div');
    card.className = 'server-card';
    card.innerHTML = `
      <button class="delete-btn" data-index="${index}">√ó</button>
      <img src="${server.imageUrl}" alt="${server.title}" class="server-banner"
        onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
      <div class="server-info">
        <h3 class="server-title">${server.title}</h3>
        <p class="server-meta">${metaInfo}</p>
        <a href="${server.inviteUrl}" class="join-btn" target="_blank" rel="noopener noreferrer">
          –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
        </a>
      </div>
    `;
    return card;
  }

  function renderServers(list = serversDatabase) {
    const container = document.getElementById('serverGrid');
    container.innerHTML = '';

    if (list.length === 0) {
      container.innerHTML = '<p class="no-servers">–ù–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
      return;
    }

    list.forEach((server, index) => {
      container.appendChild(createServerCard(server, index));
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async function () {
        const index = parseInt(this.getAttribute('data-index'));
        serversDatabase.splice(index, 1);
        await saveServers();
        renderServers();
      });
    });
  }

  function filterServers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const selectedNetwork = document.getElementById('filterSocialNetwork').value;

    const filtered = serversDatabase.filter(server => {
      const matchesSearch = server.title.toLowerCase().includes(searchTerm);
      const matchesNetwork = selectedNetwork ? server.socialNetwork === selectedNetwork : true;
      return matchesSearch && matchesNetwork;
    });

    renderServers(filtered);
  }

  document.getElementById('openModalBtn').addEventListener('click', () => {
    document.getElementById('modalOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
  });

  document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('modalOverlay').classList.remove('active');
    document.body.style.overflow = '';
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  document.getElementById('serverForm').addEventListener('submit', async function (event) {
    event.preventDefault();
    const title = document.getElementById('title').value.trim();
    const imageUrl = document.getElementById('imageUrl').value.trim();
    const inviteUrl = document.getElementById('inviteUrl').value.trim();
    const socialNetwork = document.getElementById('modalSocialNetwork').value;

    if (title && imageUrl && inviteUrl && socialNetwork) {
      serversDatabase.push({ title, imageUrl, inviteUrl, socialNetwork });
      await saveServers();
      renderServers();
      document.getElementById('modalOverlay').classList.remove('active');
      document.body.style.overflow = '';
      this.reset();
    }
  });

  // –ö–Ω–æ–ø–∫–∞ "–ù–∞–≤–µ—Ä—Ö"
  const backToTopBtn = document.getElementById('back-to-top');
  window.addEventListener('scroll', () => {
    backToTopBtn.classList.toggle('visible', window.scrollY > 300);
  });

  backToTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadServers();
    document.getElementById('searchInput').addEventListener('input', filterServers);
    document.getElementById('filterSocialNetwork').addEventListener('change', filterServers);
  });
</script>

</body>
</html>
